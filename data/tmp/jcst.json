{"map":{"0":{"type":"rich-text","contents":[{"id":"8a844ec9-a82f-4484-8b6b-2dc06380bfcc","type":"heading","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left","level":1},"content":[{"type":"text","text":"JCST","styles":{}}],"children":[]},{"id":"201138c3-9a8b-4a5c-9961-6e154b36ecbb","type":"paragraph","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left"},"content":[{"type":"text","text":"Converting the concrete syntax tree into values to that are compatible with our runtime encoding, where data object attributes have indices, not labels.","styles":{}}],"children":[]}],"loc":0},"2":{"type":"raw-code","lang":"javascript","raw":"const fromNode = node => {\n  switch (node.type) {\n    case 'comment':\n    case 'comment-node':\n    case 'rich-text':\n    case 'blank':\n      return\n    case 'recordAccess':\n      return {type: 'cst/access', 0: node.target.type === 'blank' ? {type: 'none'} : {type: 'some', 0: pair(node.target.text, node.target.loc)},\n      1: list(node.items.map(t => pair(t.text, t.loc))), 2: node.loc};\n    case 'identifier':\n      return {type: 'cst/id', 0: node.text, 1: node.loc}\n    case 'spread':\n      const inner = fromNode(node.contents)\n      return inner\n      ? {type: 'cst/spread', 0: inner, 1: node.loc}\n      : {type: 'cst/empty-spread', 0: node.loc}\n    case 'array':\n    case 'record':\n    case 'list':\n      return {type: 'cst/' + node.type, 0: list(node.values.map(fromNode).filter(Boolean)), 1: node.loc}\n    case 'string':\n      return {type: 'cst/string', 0: node.first.text, 1: list(\n        node.templates.map(item => pair(\n          fromNode(item.expr) ?? {type: 'cst/string', 0: '', 1: nil},\n          pair(item.suffix.text, item.suffix.loc)\n        ))\n      ), 2: node.loc}\n    case 'raw-code':\n      return {type: 'cst/string', 0: node.raw, 1: nil, 2: node.loc}\n  }\n  return {type: 'cst/id', 0: 'lol what' + node.type, 1: node.loc}\n}","loc":2},"21":{"loc":21,"type":"rich-text","contents":[{"id":"8e76a41f-02ae-4fa5-beb2-1c769056e297","type":"heading","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left","level":2},"content":[{"type":"text","text":"Prelude","styles":{}}],"children":[]},{"id":"eee0519b-267f-4dba-b79e-d5c8d1cac4ac","type":"paragraph","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left"},"content":[{"type":"text","text":"Some basic handy functions","styles":{}}],"children":[]}]},"23":{"type":"raw-code","lang":"javascript","raw":"const cons = (a, b) => ({type: 'cons', 0: a, 1: b})\nconst nil = {type: 'nil'}\nconst list = (values) => {\n  let v = nil\n  for (let i=values.length-1;i>=0;i--) {\n    v = cons(values[i], v)\n  }\n  return v\n}\nconst unwrapList = value => {\n  const res = [];\n  for (; value.type === 'cons'; value = value[1]) {\n    res.push(value[0]);\n  }\n  return res;\n}\nconst pair = (a, b) => ({type: ',', 0: a, 1: b})\n","loc":23},"37":{"type":"raw-code","lang":"javascript","raw":"// This is a little helper to make our tests easier to read\nconst cstToString = (cst) => {\n    switch (cst.type) {\n      case 'cst/id': return `${cst[0]}:${cst[1]}`\n      case 'cst/list': return `(${unwrapList(cst[0]).map(cstToString).join(' ')}):${cst[1]}`\n      case 'cst/array': return `[${unwrapList(cst[0]).map(cstToString).join(' ')}]:${cst[1]}`\n      case 'cst/record': return `{${unwrapList(cst[0]).map(cstToString).join(' ')}}:${cst[1]}`\n      case 'cst/spread': return `..${cstToString(cst[0])}:${cst[1]}`\n      case 'cst/access': return `${cst[0].type === 'some' ? cst[0][0][0] + ':' + cst[0][0][1] : ''}${\n        unwrapList(cst[1]).map(p => `.${p[0]}:${p[1]}`).join('')}::${cst[2]}`\n      case 'cst/string':\n        return `\"${cst[0]}${\n          unwrapList(cst[1]).map(t => `\\${${cstToString(t[0])}}${t[1][0]}:${t[1][1]}`)\n        }\":${cst[2]}`\n    }\n};\n","loc":37},"46":{"type":"list","values":[50,51,52],"loc":46},"50":{"type":"identifier","text":",","loc":50},"51":{"type":"raw-code","lang":"javascript","raw":"v => cstToString(fromNode(v))","loc":51},"52":{"type":"array","values":[56,61,74,86,247,269],"loc":52},"53":{"type":"list","values":[54,55],"loc":53},"54":{"type":"identifier","text":"@","loc":54},"55":{"type":"identifier","text":"10","loc":55},"56":{"type":"list","values":[57,53,200],"loc":56},"57":{"type":"identifier","text":",","loc":57},"58":{"type":"blank","loc":58},"59":{"type":"blank","loc":59},"61":{"type":"list","values":[62,63,201],"loc":61},"62":{"type":"identifier","text":",","loc":62},"63":{"type":"list","values":[67,68],"loc":63},"64":{"type":"blank","loc":64},"67":{"type":"identifier","text":"@","loc":67},"68":{"type":"array","values":[69,70,71,72],"loc":68},"69":{"type":"identifier","text":"1","loc":69},"70":{"type":"comment","text":"ya","loc":70},"71":{"type":"identifier","text":"2","loc":71},"72":{"type":"blank","loc":72},"74":{"type":"list","values":[75,76,202],"loc":74},"75":{"type":"identifier","text":",","loc":75},"76":{"type":"list","values":[78,79],"loc":76},"77":{"type":"blank","loc":77},"78":{"type":"identifier","text":"@","loc":78},"79":{"type":"string","first":80,"templates":[{"expr":81,"suffix":82}],"loc":79},"80":{"type":"stringText","loc":80,"text":"hi "},"81":{"type":"identifier","text":"1","loc":81},"82":{"type":"stringText","text":" 12","loc":82},"86":{"type":"list","values":[87,88,209],"loc":86},"87":{"type":"identifier","text":",","loc":87},"88":{"type":"record","values":[92,93,208],"loc":88},"89":{"type":"blank","loc":89},"92":{"type":"identifier","text":"hi","loc":92},"93":{"type":"identifier","text":"10","loc":93},"97":{"type":"raw-code","lang":"javascript","raw":"const toNode = node => {\n  switch (node.type) {\n    case 'cst/id':\n      return {type: 'identifier', text: node[0], loc: node[1]}\n    case 'cst/spread':\n      return {type: 'spread', contents: toNode(node[0]), loc: node[1]}\n    case 'cst/empty-spread':\n      return {type: 'spread', contents: {type: 'blank', loc: node[0]}, loc: node[0]}\n    case 'cst/access':\n      return {type: 'recordAccess', target: node[0].type === 'some'\n        ? {type: 'identifier', text: node[0][0][0], loc: node[0][0][1]} :\n          {type: 'blank', loc: -1},\n          items: unwrapList(node[1]).map(id => ({\n            type: 'accessText', text: id[0], loc: id[1]\n          })), loc: node[2]}\n    case 'cst/array':\n    case 'cst/list':\n    case 'cst/record':\n      return {type: node.type.slice(4), values: unwrapList(node[0]).map(toNode), loc: node[1]}\n    case 'cst/string':\n      return {type: 'string', first: {type: 'stringText', text: node[0], loc: node[2]},\n        templates: unwrapList(node[1]).map(({0: expr, 1: text, 2: loc}) => ({\n          expr: toNode(expr),\n          suffix: {text, loc},\n          loc,\n        })),\n        loc: node[2]\n      }\n  }\n}","loc":97},"99":{"type":"raw-code","lang":"javascript","raw":"({type: 'fns', fromNode, toNode})","loc":99},"101":{"type":"blank","loc":101},"102":{"type":"list","values":[104,105,106],"loc":102},"104":{"type":"identifier","text":",","loc":104},"105":{"type":"raw-code","lang":"javascript","raw":"v => equal(fromNode(v), fromNode(toNode(fromNode(v))))","loc":105},"106":{"type":"array","values":[107,114,127,281,290],"loc":106},"107":{"type":"list","values":[108,109,125],"loc":107},"108":{"type":"identifier","text":",","loc":108},"109":{"type":"list","values":[110,111],"loc":109},"110":{"type":"identifier","text":"@","loc":110},"111":{"type":"identifier","text":"10","loc":111},"112":{"type":"blank","loc":112},"113":{"type":"blank","loc":113},"114":{"type":"list","values":[115,116,126],"loc":114},"115":{"type":"identifier","text":",","loc":115},"116":{"type":"list","values":[118,119],"loc":116},"117":{"type":"blank","loc":117},"118":{"type":"identifier","text":"@","loc":118},"119":{"type":"array","values":[120,121],"loc":119},"120":{"type":"identifier","text":"1","loc":120},"121":{"type":"list","values":[122,123],"loc":121},"122":{"type":"identifier","text":"2","loc":122},"123":{"type":"identifier","text":"3","loc":123},"124":{"type":"blank","loc":124},"125":{"type":"raw-code","lang":"javascript","loc":125,"raw":"true"},"126":{"type":"raw-code","lang":"javascript","loc":126,"raw":"true"},"127":{"type":"list","values":[128,129,140],"loc":127},"128":{"type":"identifier","text":",","loc":128},"129":{"type":"list","values":[131,132],"loc":129},"130":{"type":"blank","loc":130},"131":{"type":"identifier","text":"@","loc":131},"132":{"type":"record","values":[133,134,141,138,146],"loc":132},"133":{"type":"identifier","text":"a","loc":133},"134":{"type":"identifier","text":"b","loc":134},"135":{"type":"identifier","text":"two","loc":135},"138":{"type":"spread","contents":135,"loc":138},"140":{"type":"raw-code","lang":"javascript","loc":140,"raw":"true"},"141":{"type":"string","first":142,"templates":[],"loc":141},"142":{"type":"stringText","loc":142,"text":"two"},"143":{"type":"blank","loc":143},"146":{"type":"spread","contents":143,"loc":146},"148":{"type":"recordAccess","target":147,"items":[149],"loc":148},"149":{"type":"accessText","text":"","loc":149},"151":{"type":"blank","loc":151},"152":{"type":"blank","loc":152},"154":{"type":"blank","loc":154},"155":{"type":"blank","loc":155},"156":{"loc":156,"type":"list","values":[159,160,213,161,167,217,223,173,181]},"159":{"loc":159,"type":"identifier","text":"deftype"},"160":{"loc":160,"type":"identifier","text":"cst"},"161":{"loc":161,"type":"list","values":[162,163,166]},"162":{"loc":162,"type":"identifier","text":"cst/list"},"163":{"loc":163,"type":"list","values":[164,165]},"164":{"loc":164,"type":"identifier","text":"list"},"165":{"loc":165,"type":"identifier","text":"cst"},"166":{"loc":166,"type":"identifier","text":"int"},"167":{"loc":167,"type":"list","values":[168,169,172]},"168":{"loc":168,"type":"identifier","text":"cst/array"},"169":{"loc":169,"type":"list","values":[170,171]},"170":{"loc":170,"type":"identifier","text":"list"},"171":{"loc":171,"type":"identifier","text":"cst"},"172":{"loc":172,"type":"identifier","text":"int"},"173":{"loc":173,"type":"list","values":[174,175,176]},"174":{"loc":174,"type":"identifier","text":"cst/spread"},"175":{"loc":175,"type":"identifier","text":"cst"},"176":{"loc":176,"type":"identifier","text":"int"},"181":{"loc":181,"type":"list","values":[182,183,184,191]},"182":{"loc":182,"type":"identifier","text":"cst/string"},"183":{"loc":183,"type":"identifier","text":"string"},"184":{"loc":184,"type":"list","values":[185,186]},"185":{"loc":185,"type":"identifier","text":"list"},"186":{"loc":186,"type":"list","values":[187,188,189,190]},"187":{"loc":187,"type":"identifier","text":","},"188":{"loc":188,"type":"identifier","text":"cst"},"189":{"loc":189,"type":"identifier","text":"string"},"190":{"loc":190,"type":"identifier","text":"int"},"191":{"loc":191,"type":"identifier","text":"int"},"192":{"type":"rich-text","contents":[{"id":"b1d3af82-6a87-4fad-a858-1529555d8622","type":"paragraph","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left"},"content":[{"type":"text","text":"Here's the type we're going to be producing:","styles":{}}],"children":[]}],"loc":192},"194":{"type":"rich-text","contents":[{"id":"6d121157-81c6-4763-8b5c-40ff517da11c","type":"paragraph","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left"},"content":[{"type":"text","text":"This is how we register with the structured editor that the CST nodes should be converted before getting handed over to the parser.","styles":{}}],"children":[]}],"loc":194},"196":{"type":"blank","loc":196},"197":{"type":"blank","loc":197},"198":{"type":"blank","loc":198},"199":{"type":"blank","loc":199},"200":{"type":"raw-code","lang":"javascript","loc":200,"raw":"\"10:55\""},"201":{"type":"raw-code","lang":"javascript","loc":201,"raw":"\"[1:69 2:71]:68\""},"202":{"type":"raw-code","lang":"javascript","loc":202,"raw":"'\"hi ${1:81} 12:82\":79'"},"204":{"type":"blank","loc":204},"205":{"type":"identifier","text":"a","loc":205},"208":{"type":"spread","contents":205,"loc":208},"209":{"type":"raw-code","lang":"javascript","loc":209,"raw":"\"{hi:92 10:93 ..a:205:208}:88\""},"210":{"type":"rich-text","contents":[{"id":"06db4573-49c0-423d-a118-9b69d3f0460b","type":"paragraph","props":{"textColor":"default","backgroundColor":"default","textAlignment":"left"},"content":[{"type":"text","text":"toNode can't reconstruct some of the ","styles":{}},{"type":"text","text":"loc","styles":{"code":true}},{"type":"text","text":" identifiers, so we can't do ","styles":{}},{"type":"text","text":"equal(v, toNode(fromNode(v)))","styles":{"code":true}},{"type":"text","text":".\nBut round-tripping ought to be a good indicator that things are working.","styles":{}}],"children":[]}],"loc":210},"212":{"type":"blank","loc":212},"213":{"loc":213,"type":"list","values":[214,215,216]},"214":{"loc":214,"type":"identifier","text":"cst/id"},"215":{"loc":215,"type":"identifier","text":"string"},"216":{"loc":216,"type":"identifier","text":"int"},"217":{"type":"list","values":[218,219,222],"loc":217},"218":{"type":"identifier","text":"cst/record","loc":218},"219":{"type":"list","values":[220,221],"loc":219},"220":{"type":"identifier","text":"list","loc":220},"221":{"type":"identifier","text":"cst","loc":221},"222":{"type":"identifier","text":"int","loc":222},"223":{"type":"list","values":[224,225,228,231],"loc":223},"224":{"type":"identifier","text":"cst/access","loc":224},"225":{"type":"list","values":[226,265],"loc":225},"226":{"type":"identifier","text":"option","loc":226},"227":{"type":"identifier","text":",","loc":227},"228":{"type":"list","values":[229,262],"loc":228},"229":{"type":"identifier","text":"list","loc":229},"230":{"type":"identifier","text":",","loc":230},"231":{"type":"identifier","text":"int","loc":231},"235":{"type":"recordAccess","target":232,"items":[236],"loc":235},"236":{"type":"accessText","text":"","loc":236},"239":{"type":"recordAccess","target":237,"items":[240],"loc":239},"240":{"type":"accessText","text":"","loc":240},"247":{"type":"list","values":[248,249,250],"loc":247},"248":{"type":"identifier","text":",","loc":248},"249":{"type":"list","values":[253,259],"loc":249},"250":{"type":"raw-code","lang":"javascript","loc":250,"raw":"\"a:254.b:260.x:261::259\""},"251":{"type":"recordAccess","target":249,"items":[252],"loc":251},"252":{"type":"accessText","text":"","loc":252},"253":{"type":"identifier","text":"@","loc":253},"254":{"type":"identifier","text":"a","loc":254},"255":{"type":"recordAccess","target":254,"items":[256],"loc":255},"256":{"type":"accessText","text":"","loc":256},"257":{"type":"recordAccess","target":254,"items":[258],"loc":257},"258":{"type":"accessText","text":"","loc":258},"259":{"type":"recordAccess","target":254,"items":[260,261],"loc":259},"260":{"type":"accessText","text":"b","loc":260},"261":{"type":"accessText","text":"x","loc":261},"262":{"type":"list","values":[230,263,264],"loc":262},"263":{"type":"identifier","text":"string","loc":263},"264":{"type":"identifier","text":"int","loc":264},"265":{"type":"list","values":[227,266,267],"loc":265},"266":{"type":"identifier","text":"string","loc":266},"267":{"type":"identifier","text":"int","loc":267},"269":{"type":"list","values":[270,271,272],"loc":269},"270":{"type":"identifier","text":",","loc":270},"271":{"type":"list","values":[273,276],"loc":271},"272":{"type":"raw-code","lang":"javascript","loc":272,"raw":"\".abc:277::276\""},"273":{"type":"identifier","text":"@","loc":273},"274":{"type":"blank","loc":274},"275":{"type":"stringText","loc":275,"text":""},"276":{"type":"recordAccess","target":274,"items":[277],"loc":276},"277":{"type":"accessText","text":"abc","loc":277},"281":{"type":"list","values":[282,283,284],"loc":281},"282":{"type":"identifier","text":",","loc":282},"283":{"type":"list","values":[285,287],"loc":283},"284":{"type":"raw-code","lang":"javascript","loc":284,"raw":"true"},"285":{"type":"identifier","text":"@","loc":285},"286":{"type":"blank","loc":286},"287":{"type":"recordAccess","target":286,"items":[288],"loc":287},"288":{"type":"accessText","text":"abc","loc":288},"290":{"type":"list","values":[291,292,293],"loc":290},"291":{"type":"identifier","text":",","loc":291},"292":{"type":"list","values":[295,297],"loc":292},"293":{"type":"raw-code","lang":"javascript","loc":293,"raw":"true"},"295":{"type":"identifier","text":"@","loc":295},"296":{"type":"identifier","text":"one","loc":296},"297":{"type":"recordAccess","target":296,"items":[298,299],"loc":297},"298":{"type":"accessText","text":"two","loc":298},"299":{"type":"accessText","text":"three","loc":299},"300":{"type":"blank","loc":300},"302":{"type":"recordAccess","target":300,"items":[303],"loc":302},"303":{"type":"accessText","text":"abc","loc":303},"-1":{"type":"list","values":[0],"loc":-1}},"root":-1,"meta":{},"history":[],"clipboard":[],"hover":[{"type":"card","idx":-1,"card":0},{"type":"ns","child":3,"idx":0},{"type":"ns-top","idx":3}],"regs":{},"at":[{"start":[{"type":"card","idx":-1,"card":0},{"type":"ns","child":3,"idx":0},{"type":"ns-top","idx":3},{"type":"rich-text","idx":2,"sel":null}]}],"cards":[{"path":[],"top":0}],"nsMap":{"0":{"id":0,"top":-1,"children":[1,20,193,3,98,195],"type":"normal"},"1":{"id":1,"top":0,"children":[],"type":"normal"},"3":{"type":"normal","top":2,"children":[47],"id":3,"collapsed":false},"20":{"type":"normal","id":20,"top":21,"children":[22],"collapsed":true},"22":{"type":"normal","id":22,"top":23,"children":[],"collapsed":false},"36":{"type":"normal","id":36,"top":37,"children":[]},"47":{"type":"normal","top":46,"children":[36],"id":47,"plugin":{"id":"fixture","options":null},"collapsed":true},"98":{"type":"normal","top":97,"children":[211,103],"id":98},"100":{"type":"normal","top":99,"children":[],"id":100,"plugin":{"id":"evaluator","options":"jcst.js"}},"103":{"type":"normal","top":102,"children":[],"id":103,"plugin":{"id":"fixture","options":null}},"157":{"type":"normal","top":156,"children":[],"id":157,"display":{"id":"none","options":null}},"193":{"type":"normal","top":192,"id":193,"children":[157,301]},"195":{"type":"normal","top":194,"children":[100],"id":195},"211":{"type":"normal","top":210,"id":211,"children":[]},"301":{"type":"normal","top":302,"children":[],"id":301}},"highlight":[],"evaluator":":js:"}